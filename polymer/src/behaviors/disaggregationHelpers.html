<script>
    (function () {
      'use strict';

      var matchers = {
        '(?,?)': function () {
          return /^\((\d*),\s?(\d*)\)$/;
        },

        '(?,?,?)': function () {
          return /^\((\d*),\s?(\d*),\s?(\d*)\)$/;
        },

        '(?,Y)': function (y) {
          return new RegExp('^\\((\\d+),\\s?(' + y + ')\\)$');
        },

        '(X,?)': function (x) {
          return new RegExp('^\\((' + x + '),\\s?(\\d+)\\)$');
        },

        '(X,Y,?)': function (x, y) {
          return new RegExp('^\\((' + x + '),\\s?(' + y + '),\\s?(\\d+)\\)$');
        },

        '(X,?,Z)': function (x, z) {
          return new RegExp('^\\((' + x + '),\\s?(\\d+),\\s?(' + z + ')\\)$');
        },
      };

      function sumDisaggValues(fields) {
        return fields.reduce(function (acc, curr) {
          return acc + curr.v; // FIXME
        }, 0);
      }

      function getCoords2(key) {
        return matchers['(?,?)']()
            .exec(key)
            .slice(1, 3);
      }

      function getCoords3(key) {
        return matchers['(?,?,?)']()
            .exec(key)
            .slice(1, 4);
      }

      function extractFields(data, re) {
        return Object.keys(data)
            .filter(function (k) {
              return re.exec(k);
            })
            .map(function (k) {
              return data[k];
            });
      }

      function formatField(v) {
        return {
          v: v, // FIXME
        };
      }

      function formatKey() {
        var chunks = [].slice.call(arguments);
        var formatted = '(' + chunks.join(', ') + ')';

        return formatted.replace(/(,)(\s)(\))$/, '$1$3');
      }

      App.Behaviors = App.Behaviors || {};

      App.Behaviors.DisaggregationHelpersBehavior = {
        _calculateLevel1: function (key, data) {
          var coords = getCoords2(key);
          var y = coords[1];
          var yRe = matchers['(?,Y)'](y);
          var yFields = extractFields(data, yRe);

          var totals = {};

          var yKey = formatKey(y);

          totals[yKey] = formatField(sumDisaggValues(yFields));

          return totals;
        },

        _calculateLevel2: function (key, data) {
          var coords = getCoords2(key);
          var x = coords[0];
          var y = coords[1];
          var xRe = matchers['(X,?)'](x);
          var yRe = matchers['(?,Y)'](y);
          var xFields = extractFields(data, xRe);
          var yFields = extractFields(data, yRe);

          var totals = {};

          var xKey = formatKey(x, '');
          var yKey = formatKey(y, '');

          totals[xKey] = formatField(sumDisaggValues(xFields));
          totals[yKey] = formatField(sumDisaggValues(yFields));

          return totals;
        },

        _calculateLevel3: function (key, data) {
          var coords = getCoords3(key);
          var x = coords[0];
          var y = coords[1];
          var z = coords[2];

          var xyRe = matchers['(X,Y,?)'](x, y);
          var xzRe = matchers['(X,?,Z)'](x, z);

          var xyFields = extractFields(data, xyRe);
          var xzFields = extractFields(data, xzRe);

          var totals = {};

          var xyKey = formatKey(x, y);
          var xzKey = formatKey(x, z);

          totals[xyKey] = formatField(sumDisaggValues(xyFields));
          totals[xzKey] = formatField(sumDisaggValues(xzFields));

          return totals;
        },
      };
    }());
  </script>
