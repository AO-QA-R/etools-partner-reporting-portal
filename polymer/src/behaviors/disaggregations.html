<link rel="import" href="../polyfills/es6-shim.html">

<script>
  (function () {
    'use strict';

    App.Behaviors = App.Behaviors || {};

    App.Behaviors.DisaggregationBehavior = {

      //Used to display rows for two and three disaggregations.
      //It will NOT work for one and zero disaggregations.
      _determineRows: function(self, rows, columns) {
        var rowsForDisplay = [];

        rows.forEach(function(x) {
          var formatted = '';

          var rowData = columns.map(function(z) {
            formatted = self._formatDisaggregationIds([x.id, z.id]);

            return {
              key: formatted,
              data: self.data.disaggregation[formatted],
            };
          });

          formatted = self._formatDisaggregationIds([x.id]);

          rowsForDisplay.push({
            title: x.value,
            data: rowData,
            id: x.id,
            total: {
              key: formatted,
              data: self.data.disaggregation[formatted],
            },
          });
        });

        return rowsForDisplay;
      },

      // Accepts a list of disaggregation IDs, sorts them, and
      // structures them in "()" format for lookup.
      _formatDisaggregationIds: function (unsortedIds) {
        // IDs must be in ascending order.
        var ids = unsortedIds.sort(function (a, b) {return a - b;}).reverse();
        var sortedString = '';

        if (ids.length === 1) {
          sortedString = ids[0] + ',';
        } else {
          sortedString = ids.join(', ');
        }

        return '(' + sortedString + ')';
      },

      regenerate_disaggregation_key_entries: function (
        new_level_reported,
        new_disaggregation_reported_on,
        disagg_lookup_map
      ) {
        var new_disaggregation = {};
        var formatted_id_list = Array();

        /*
        * We first filter disaggregation choice ids from disagg_lookup_map based on
        * Disaggregation IDs that new_disaggregation_reported_on has.
        *
        * Then, extract integer id only from each filtered disaggregation object's
        * choice object list. This would return as [[1,2,3], [4,5,6], [7,8]] format,
        * where each nested array is the disaggregation choice id list for selected
        * disaggregation.
        */
        var filtered_disagg_choice_ids = disagg_lookup_map.filter(function (disagg_item) {
          return new_disaggregation_reported_on.indexOf(disagg_item.id) !== -1;
        }).map(function (filtered_disagg_item) {
          return filtered_disagg_item.choices.map(function (choice_object) {
            return choice_object.id;
          });
        });

        // This loops from N level_reported to 0 level_reported. Each iteration generates
        // a set of cartesian product of each given combination for filtered disaggregation
        // choice integer id arrays
        for (var i = 0; i <= new_level_reported; i++) {
          // Get nCr entries for each level_reported
          var level_combination_entries = this._combinations(filtered_disagg_choice_ids, i);

          for (var j = 0; j < level_combination_entries.length; j++) {
            // Create a cartesian product set for each combination entry
            var product_ids = this._cartesianProduct(level_combination_entries[j]);

            // Format each generated combination key according to backend format
            var formatted_product_ids = product_ids.map(function(item) {
              var formatted_id = item.join(', ');

              if (item.length === 1) {
                formatted_id = formatted_id + ',';
              }

              return '(' + formatted_id + ')';
            });

            Array.prototype.push.apply(formatted_id_list, formatted_product_ids)
          }
        }

        // Populate each new key into empty disaggregation object
        for (var k = 0; k < formatted_id_list.length; k++) {
          new_disaggregation[formatted_id_list[k]] = {
            c: null,
            d: null,
            v: null,
          };
        }

        return new_disaggregation;
      },
    };

}());
</script>
