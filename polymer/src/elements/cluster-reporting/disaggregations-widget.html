<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../styles/buttons.html">

<dom-module id="disaggregations-widget">
  <template>
    <style include="button-styles iron-flex iron-flex-alignment">
      :host {
        display: block;
      }

      h2 {
        padding: 5px 10px;
        margin: 0 0 1em;
        font-size: 14px;
        background-color: var(--paper-grey-200);
      }

      .error,
      .remove-btn {
        color: var(--paper-deep-orange-a700);
      }

      .row {
        margin-bottom: 1em;
      }

      .remove-btn {
        width: 34px;
        height: 34px;
      }

      .add-disaggregation-btn {
        margin: 0;
      }

      .col-actions {
        width: 40px;
        border-right: 1px solid var(--paper-grey-400);
      }

      .col-name,
      .col-values {
        padding: 10px 0 10px 24px;
      }
    </style>

    <h2 class$="[[_headingClassName]]">Disaggregations ([[value.length]])</h2>

    <template
        is="dom-repeat"
        items="[[value]]">
      <div class="row layout horizontal">
        <div class="flex-none layout vertical center-center col-actions">
          <paper-icon-button
              class="remove-btn"
              index="[[index]]"
              on-tap="_remove"
              icon="icons:cancel">
          </paper-icon-button>
        </div>
        <div class="flex col-name">
          Name
        </div>
        <div class="flex col-values">
          Values
        </div>
      </div>
    </template>

    <paper-button
        class="btn-primary add-disaggregation-btn"
        on-tap="_add"
        disabled="[[!_canAddMore]]">
      Add disaggregation
    </paper-button>
  </template>

  <script>
    Polymer({
      id: 'disaggregations-widget',

      properties: {
        threshold: {
          type: Number,
          value: 3,
        },

        value: {
          type: Array,
          value: [],
          notify: true,
        },

        invalid: {
          type: Boolean,
          notify: true,
          computed: '_computeInvalid(required, value)',
        },

        required: {
          type: Boolean,
          value: false,
        },

        _canAddMore: {
          type: Boolean,
          computed: '_computeCanAddMore(threshold, value)',
        },

        _invalid: {
          type: Boolean,
          value: false,
        },

        _headingClassName: {
          type: String,
          computed: '_computeHeadingClassName(_invalid)',
        },
      },

      _computeInvalid: function (required, value) {
        if (!required) {
          return false;
        }

        if (!value.length) {
          return true;
        }

        return value.some(function (disagg) {
          return !disagg.name.length || !disagg.values.length;
        });
      },

      _computeHeadingClassName: function (invalid) {
        return invalid ? 'error' : '';
      },

      _computeCanAddMore: function (threshold, value) {
        return value.length < threshold;
      },

      _add: function () {
        var value = this.value.slice();

        value.push({
          name: 'FIXME',
          values: ['FIXME'],
        });

        this.set('value', value);
        this.fire('disaggregations-updated');
      },

      _remove: function (e) {
        var value = this.value.slice();
        var toRemove = +e.target.index;

        value.splice(toRemove, 1);

        this.set('value', value);
        this.fire('disaggregations-updated');
      },

      validate: function () {
        this.set('_invalid', this.invalid);
      },
    });
  </script>
</dom-module>
