<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/promise-polyfill/promise-polyfill-lite.html">

<link rel="import" href="table-content/three-disaggregations.html">
<link rel="import" href="table-content/two-disaggregations.html">
<link rel="import" href="table-content/one-disaggregation.html">
<link rel="import" href="table-content/zero-disaggregations.html">
<link rel="import" href="../etools-prp-ajax.html">
<link rel="import" href="../../endpoints.html">
<link rel="import" href="../../redux/store.html">
<link rel="import" href="../../redux/actions.html">
<link rel="import" href="../../behaviors/utils.html">
<link rel="import" href="../../styles/disaggregation-table-styles.html">

<dom-module id="disaggregation-table">
  <template>
    <style include="disaggregation-table-styles"></style>

    <etools-prp-ajax
        id="update"
        url="[[updateUrl]]"
        body="[[localData]]"
        content-type="application/json"
        method="put">
    </etools-prp-ajax>

    <table class="vertical layout">

      <!-- Note: Need to pass in mapping to these or an empty mapping is passed
      to the content component. -->
      <template is="dom-if" if="[[_equals(data.num_disaggregation, 0)]]">
        <zero-disaggregations
            data="[[data]]"
            total="[[total]]"
            mapping="[[mapping]]"
            editable="[[editable]]">
        </zero-disaggregations>
      </template>

      <template is="dom-if" if="[[_equals(data.num_disaggregation, 1)]]">
        <one-disaggregation
            data="[[data]]"
            total="[[total]]"
            mapping="[[mapping]]"
            editable="[[editable]]">
        </one-disaggregation>
      </template>

      <template is="dom-if" if="[[_equals(data.num_disaggregation, 2)]]">
        <two-disaggregations
            data="[[data]]"
            total="[[total]]"
            mapping="[[mapping]]"
            editable="[[editable]]">
        </two-disaggregations>
      </template>

      <template is="dom-if" if="[[_equals(data.num_disaggregation, 3)]]">
        <three-disaggregations
            data="[[data]]"
            total="[[total]]"
            mapping="[[mapping]]"
            editable="[[editable]]">
        </three-disaggregations>
      </template>

    </table>

  </template>

  <script>

    Polymer({
      is: 'disaggregation-table',

      behaviors: [
        App.Behaviors.UtilsBehavior,
        App.Behaviors.ReduxBehavior,
      ],

      properties: {
        editable: {
          type: Boolean,
          value: false,
        },

        fields: Array,

        data: {
          type: Object,
          observer: '_cloneData',
        },

        updateUrl: {
          type: String,
          value: App.Endpoints.indicatorLocationDataEntries(),
        },

        localData: Object,

        mapping: Object,

        total: Number,
      },

      listeners: {
        'register-field': '_registerField',
        'deregister-field': '_deregisterField',
        'field-value-changed': '_fieldValueChanged',
      },

      _registerField: function (e, field) {
        e.stopPropagation();

        if (!this.fields) {
          this.set('fields', []);
        }

        this.push('fields', field);
      },

      _deregisterField: function (e, field) {
        var index = this.fields.indexOf(field);

        e.stopPropagation();

        if (index === -1) {
          return;
        }

        this.splice('fields', index, 1);
      },

      _fieldValueChanged: function (e, change) {
        e.stopPropagation();

        this.set(['localData.disaggregation', change.key], {
          c: null,
          d: null,
          v: change.value,
        });
      },

      _cloneData: function (data) {
        if (!this.editable) {
          return;
        }

        this.set('localData', this._clone(data));
      },

      save: function () {
        var updateThunk;
        var valid;

        if (!this.editable) {
          return Promise.reject();
        }

        this.fields.forEach(function (field) {
          field.validate();
        });

        valid = this.fields.every(function (field) {
          return !field.invalid;
        });

        if (!valid) {
          return Promise.reject();
        }

        updateThunk = this.$.update.thunk();

        this.$.update.abort();

        return this.dispatch(
          App.Actions.Disaggregations.updateForLocation(
            updateThunk,
            this.indicatorId,
            this.data.location.id
          )
        );
      },
    });
  </script>
</dom-module>
