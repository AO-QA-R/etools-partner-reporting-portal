<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-data-table/etools-data-table.html">

<link rel="import" href="../../../behaviors/utils.html">
<link rel="import" href="../../../styles/detail-table.html">
<link rel="import" href="../disaggregation-table-row.html">

<dom-module id="three-disaggregations">
  <template>

    <style include='detail-table'>
      .cell {
        word-break: break-word;
      }
    </style>

    <tr class='horizontal layout'>
      <th class='flex cell'></th>
      <template is="dom-repeat"
                items="[[columns]]"
                as="column">
        <th class='flex cell'>[[_capitalizeFirstLetter(column.value)]]</th>
      </template>
      <th class='flex cell'>Total</th>
    </tr>

    <template is="dom-repeat"
              items="[[outerRowsForDisplay]]"
              as="outerRow">
      <disaggregation-table-row data=[[outerRow]] type="outerRow"></disaggregation-table-row>
      <template is="dom-repeat"
                items="[[_determineMiddleRows(outerRow.id)]]"
                as="middleRow">
        <disaggregation-table-row data=[[middleRow]]></disaggregation-table-row>
      </template>
   </template>

   <!-- <disaggregation-table-row data=[[columnTotalRow]]></disaggregation-table-row> -->

  </template>

  <script>
    Polymer({
      is: 'three-disaggregations',

      behaviors: [
        App.Behaviors.UtilsBehavior,
      ],

      properties: {
        data: {
          type: Object,
          value: {}
        },

        mapping: {
          type: Array,
          value: []
        },

        //Passing columnNames as a param is required to trigger update.
        columns: {
          type: Array,
          computed: '_getColumns(mapping)'
        },

        outerRows: {
          type: Array,
          computed: '_getOuterRows(mapping)'
        },

        middleRows: {
          type: Array,
          computed: '_getMiddleRows(mapping)'
        },

        outerRowsForDisplay: {
          type: Array,
          computed: '_determineOuterRows(mapping)'
        },

        totalsForDisplay: {
          type: Array,
          computed: '_determineTotals(mapping)'
        }
      },

      _getColumns: function(mapping) {
        return this.mapping[0].choices;
      },

      _getOuterRows: function(mapping) {
        return this.mapping[1].choices;
      },

      _getMiddleRows: function(mapping) {
        return this.mapping[2].choices;
      },

      // Accepts a list of IDs, sorts them, and structures them in "()" format.
      _getData(ids) {
        var sortedString = ids.sort().join(", ");
        var formatted = '(' + sortedString + ')';
        return this.data.disaggregation[formatted];
      },

      _determineOuterRows: function() {
        var self = this;
        var columnChoices = this.mapping[0].choices;
        var outerRows = this.mapping[1].choices;
        var middleRows = this.mapping[2].choices;
        var outerRowsForDisplay = [];

        outerRows.map(function(x) {
          var title = x.value;
          var outerRowData = columnChoices.map(function(z) {
            return self._getData([x.id, z.id]);
          });
          var outerRowTotal = self._getData([x.id]);

          outerRowsForDisplay.push({
            title: x.value,
            data: outerRowData,
            id: x.id,
            total: outerRowTotal
          });
        });
        return outerRowsForDisplay
      },

      _determineMiddleRows(outerRowID) {
        var self = this;
        var columnChoices = this.mapping[0].choices;
        var middleRows = this.mapping[2].choices;
        var middleRowsForDisplay = [];

        middleRows.map(function(y) {
          var data = columnChoices.map(function(z) {
            return self._getData( [outerRowID, y.id, z.id] ) ;
          });
          var total = self._getData([y.id]);

          middleRowsForDisplay.push({
            title: y.value,
            data: data,
            id: y.id,
            total: total
          });
        });
        return middleRowsForDisplay;
      },

      _determineTotals: function() {
        var self = this;
        var columnChoices = this.mapping[0].choices;
        var middleRows = this.mapping[2].choices;
        var middleRowsForDisplay = [];
        var columnTotalRow = {}

        var columnData = columnChoices.map(function(z) {
          return self._getData([z.id]) ;
        });

      },

    });
  </script>
</dom-module>
