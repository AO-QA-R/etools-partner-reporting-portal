<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../behaviors/disaggregations.html">
<link rel="import" href="../../../behaviors/utils.html">
<link rel="import" href="../../../styles/disaggregation-table-styles.html">
<link rel="import" href="../disaggregation-table-row.html">

<dom-module id="two-disaggregations">
  <template>

    <style include='disaggregation-table-styles'></style>

    <tr class='horizontal layout headerRow'>
      <th class='flex'></th>

      <template is="dom-repeat"
                items="[[columns]]"
                as="column">
        <th class="flex">[[_capitalizeFirstLetter(column.value)]]</th>
      </template>

      <th class='flex'>Total</th>
    </tr>

    <template
        is="dom-repeat"
        items="[[rowsForDisplay]]"
        as="row">
      <disaggregation-table-row
          data="[[row]]"
          level-reported="[[data.level_reported]]"
          row-type="middleRow"
          editable="[[editable]]">
      </disaggregation-table-row>
    </template>

   <disaggregation-table-row
      data="[[totalsForDisplay]]"
      level-reported="[[data.level_reported]]"
      row-type="totalsRow">
  </disaggregation-table-row>

  </template>

  <script>
    Polymer({
      is: 'two-disaggregations',

      behaviors: [
        App.Behaviors.UtilsBehavior,
        App.Behaviors.DisaggregationBehavior,
      ],

      properties: {
        editable: Number,

        data: Object,

        mapping: Array,

        //Passing columnNames as a param is required to trigger update.
        columns: {
          type: Array,
          computed: '_getColumns(mapping)'
        },

        totalsForDisplay: {
          type: Object,
          computed: '_determineTotals(columns, data)',
        },

        rowsForDisplay: {
          type: Object,
          computed: '_determineRowsForDisplay(mapping, data)'
        },
      },

      _getColumns: function(mapping) {
        return mapping[0].choices;
      },

      _determineRowsForDisplay: function() {
        var columnChoices = this.mapping[0].choices;
        var rows = this.mapping[1].choices;
        return this._determineRows(this, rows, columnChoices);
      },

      _determineTotals: function(_, data) {
        var self = this;
        var columnChoices = this.mapping[0].choices;

        var columnData = columnChoices.map(function(z) {
          var formatted = self._formatDisaggregationIds([z.id]);

          return {
            key: formatted,
            data: data.disaggregation[formatted],
          };
        });

        var columnTotalRow = {
          title: 'total',
          data: columnData,
          total: {
            key: '', // unused,
            data: data.disaggregation['()'],
          },
        };

        return columnTotalRow;
      },
    });
  </script>
</dom-module>
