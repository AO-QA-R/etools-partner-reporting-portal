<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../../behaviors/utils.html">
<link rel="import" href="../etools-prp-ajax.html">
<link rel="import" href="../../elements/disaggregations/disaggregation-table.html">
<link rel="import" href="../../redux/store.html">
<link rel="import" href="../../endpoints.html">

<dom-module id="ip-reporting-indicator-details">
  <template>

    <!-- Styles the headers above the disaggregation tables.
    The tables themselves are styled in disaggregation-table-styles. -->
    <style include="iron-flex iron-flex-factors disaggregation-table-styles">
      :host {
        display: block;
        width: 100%;
      }
      iron-icon {
        color: var(--accent-color);
      }
      h3 {
        width: 100%;
        float: left;
      }
    </style>

    <etools-prp-ajax
        id="indicatorDetail"
        url="[[indicatorDetailUrl]]">
    </etools-prp-ajax>

    <etools-loading active="[[loading]]"></etools-loading>

      <template is="dom-repeat"
                items="[[locations]]"
                as="location">

        <h3>
          <iron-icon icon="maps:place"></iron-icon>
          [[location.0.location.title]]
        </h3>

        <div class="container">
          <template is="dom-repeat"
                    items="[[location]]"
                    as="item">

            <div class="item">
              <h4>
                <span>
                  <strong>Progress in reporting period: </strong>
                  [[data.time_period_start]] - [[data.time_period_end]]
                </span>
                <span class="total">
                  <strong>Total: </strong>[[data.total]]
                </span>
              </h4>
              <disaggregation-table
                total=[[data.total]]
                data=[[item]]
                mapping=[[data.disagg_lookup_map]]>
              </disaggregation-table>
            </div>
          </template>
        </div>

    </template>

  </template>

  <script>

    Polymer({
      is: 'ip-reporting-indicator-details',

      behaviors: [
        App.Behaviors.UtilsBehavior,
        App.Behaviors.ReduxBehavior,
      ],

      properties: {
        indicatorDetailUrl: {
          type: String,
          computed: '_computeIndicatorReportsUrl(indicatorId)',
        },

        isOpen: {
          type: Boolean,
          observer: '_openChanged',
        },

        indicatorId: Number,

        loading: Boolean,

        // TODO: finish hooking up Redux so changes to the store will be reflected.
        data: {
          type: Object,
          value: {}
        },

        locations: {
          type: Array,
          computed: '_bucketByLocation(data)'
        }
      },

      _computeIndicatorReportsUrl: function (indicatorId) {
        return App.Endpoints.indicatorReports(indicatorId);
      },

      _bucketByLocation: function (data) {
        var locations = {};

        if (Object.keys(data).length > 0) {
          data.indicator_location_data.forEach(function(report) {
            if (locations[report.location.id]) {
              var currentArray = locations[report.location.id];
              var newArray = currentArray;
              newArray.push(report);
              locations[report.location.id] = newArray;
            } else {
              locations[report.location.id] = [report];
            }
          });
        }
        var locationList = [];

        Object.keys(locations).forEach(function(i) {
          locationList.push(locations[i]);
        });
        return locationList;
      },

      _updateDisaggregationStore: function (data) {
        this.dispatch(App.Actions.setIndicatorDisaggregations(data));
      },

      _openChanged: function () {
        var self = this;
        if (this.isOpen) {
          self.loading = true;
          this.$.indicatorDetail.thunk()()
            .then(function (res) {
              var data = res.data;

              //TODO: Remove when API doesn't return all permutations anymore.
              //Strips out the 1-2 unwanted objects (fakedata glitch):
              if (data.length === 6) {
                res.data.shift();
              }
              if (data.length === 5) {
                res.data.shift();
              }
              var numDisaggs = 3;
              var selectedData = data[numDisaggs];
              self.data = selectedData;

              self.loading = false;
              self._updateDisaggregationStore(selectedData);
            });
            // TODO: error handling.
        } else {
          this.$.indicatorDetail.abort();
        }
      },

    });
  </script>
</dom-module>
